---
layout: post
title: "Contribuição para o Kernel Linux: Modernização do driver AD7476"
date: 2025-04-29 13:05:18 -0300
author: Cesar Bispo
categories: [linux, kernel, iio, patch]
---

Enviei recentemente um patch para a *mailing list* do kernel Linux, propondo uma modernização no driver `ad7476` e `qcom-pm8xxx-xoadc`.  
Abaixo, compartilho os detalhes da contribuição.

---

### Assunto do patch:
```
[PATCH 1/2] iio: adc: ad7476: modernize single regulator call
```

### Resumo da mudança:
Substituí chamadas legadas de obtenção de reguladores por chamadas modernas com  
`devm_regulator_get_enable()` e `devm_regulator_get_enable_optional()`.  
Isso melhora a clareza do código e segue práticas atuais do kernel.

### Autores:

- **Cesar Bispo** <cesar.bispo@ime.usp.br>  
- **Gabriel Ferreira** <gabrielfsouza.araujo@usp.br>

### Patch:

```diff
diff --git a/drivers/iio/adc/ad7476.c b/drivers/iio/adc/ad7476.c
index 37b0515cf4fc..33155f76230e 100644
--- a/drivers/iio/adc/ad7476.c
+++ b/drivers/iio/adc/ad7476.c
@@ -314,7 +314,7 @@ static int ad7476_probe(struct spi_device *spi)
	st->chip_info =
		&ad7476_chip_info_tbl[spi_get_device_id(spi)->driver_data];

-	reg = devm_regulator_get(&spi->dev, "vcc");
+	reg = devm_regulator_get_enable(&spi->dev, "vcc");
	if (IS_ERR(reg))
		return PTR_ERR(reg);

@@ -334,11 +334,11 @@ static int ad7476_probe(struct spi_device *spi)

	/* If a device has an internal reference vref is optional */
	if (st->chip_info->int_vref_uv) {
-		reg = devm_regulator_get_optional(&spi->dev, "vref");
+		reg = devm_regulator_get_enable_optional(&spi->dev, "vref");
		if (IS_ERR(reg) && (PTR_ERR(reg) != -ENODEV))
			return PTR_ERR(reg);
	} else {
-		reg = devm_regulator_get(&spi->dev, "vref");
+		reg = devm_regulator_get_enable(&spi->dev, "vref");
		if (IS_ERR(reg))
			return PTR_ERR(reg);
	}
```



---

### Assunto do patch:
```
[PATCH 2/2] iio: adc: qcom-pm8xxx-xoadc: modernize single regulator call
```

### Resumo da mudança:
Substituí uma instância de chamada legada de regulador por `devm_regulator_get_enable()`.  
Essa mudança melhora a clareza do código e alinha com as APIs modernas do kernel.

### Autores:

- **Cesar Bispo** <cesar.bispo@ime.usp.br>  
- **Gabriel Ferreira** <gabrielfsouza.araujo@usp.br>

### Patch:

```diff
diff --git a/drivers/iio/adc/qcom-pm8xxx-xoadc.c b/drivers/iio/adc/qcom-pm8xxx-xoadc.c
index 31f88cf7f7f1..c99d6acac059 100644
--- a/drivers/iio/adc/qcom-pm8xxx-xoadc.c
+++ b/drivers/iio/adc/qcom-pm8xxx-xoadc.c
@@ -911,7 +911,7 @@ static int pm8xxx_xoadc_probe(struct platform_device *pdev)
	adc->map = map;

	/* Bring up regulator */
-	adc->vref = devm_regulator_get(dev, "xoadc-ref");
+	adc->vref = devm_regulator_get_enable(dev, "xoadc-ref");
	if (IS_ERR(adc->vref))
		return dev_err_probe(dev, PTR_ERR(adc->vref),
				     "failed to get XOADC VREF regulator\n");
```




> ---
>  drivers/iio/adc/qcom-pm8xxx-xoadc.c | 2 +-
>  1 file changed, 1 insertion(+), 1 deletion(-)
> 
> diff --git a/drivers/iio/adc/qcom-pm8xxx-xoadc.c b/drivers/iio/adc/qcom-pm8xxx-xoadc.c
> index 31f88cf7f7f1..c99d6acac059 100644
> --- a/drivers/iio/adc/qcom-pm8xxx-xoadc.c
> +++ b/drivers/iio/adc/qcom-pm8xxx-xoadc.c
> @@ -911,7 +911,7 @@ static int pm8xxx_xoadc_probe(struct platform_device *pdev)
> 	adc->map = map;
>  
> 	/* Bring up regulator */
> -	adc->vref = devm_regulator_get(dev, "xoadc-ref");
> +	adc->vref = devm_regulator_get_enable(dev, "xoadc-ref");
> This doesn't return a pointer....
> 	if (IS_ERR(adc->vref))
> 		return dev_err_probe(dev, PTR_ERR(adc->vref),
> 				     "failed to get XOADC VREF regulator\n");
